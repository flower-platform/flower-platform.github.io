<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/components/timebar.js | @crispico/react-timeline-10000</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Performance focused timeline for react"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="@crispico/react-timeline-10000"><meta property="twitter:description" content="Performance focused timeline for react"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/React9k/react-timeline-9000"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/timeline.js~Timeline.html">Timeline</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components">components</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/body.js~TimelineBody.html">TimelineBody</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/renderers.js~DefaultColumnHeaderRenderer.html">DefaultColumnHeaderRenderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/renderers.js~DefaultGroupRenderer.html">DefaultGroupRenderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/selector.js~SelectBox.html">SelectBox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/timebar.js~Timebar.html">Timebar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Marker">Marker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-DefaultItemRenderer">DefaultItemRenderer</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#consts">consts</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-timebarFormat">timebarFormat</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-intToPix">intToPix</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pixToInt">pixToInt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sumStyle">sumStyle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getMaxOverlappingItems">getMaxOverlappingItems</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getNearestRowNumber">getNearestRowNumber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getNearestRowObject">getNearestRowObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getRowObjectRowNumber">getRowObjectRowNumber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTrueBottom">getTrueBottom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getVerticalMarginBorder">getVerticalMarginBorder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rowLayerRenderer">rowLayerRenderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertDateToMoment">convertDateToMoment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertMomentToDateType">convertMomentToDateType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDurationFromPixels">getDurationFromPixels</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getPixelAtTime">getPixelAtTime</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getSnapPixelFromDelta">getSnapPixelFromDelta</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTimeAtPixel">getTimeAtPixel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pixelsPerMillisecond">pixelsPerMillisecond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-timeSnap">timeSnap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://momentjs.com/">moment</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/components/timebar.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

import React from &apos;react&apos;;
import PropTypes from &apos;prop-types&apos;;
import _ from &apos;lodash&apos;;
import moment from &apos;moment&apos;;
import {intToPix} from &apos;../utils/commonUtils&apos;;
import {DefaultColumnHeaderRenderer} from &apos;./renderers&apos;;
import {timebarFormat as defaultTimebarFormat} from &apos;../consts/timebarConsts&apos;;

/**
 * Timebar component - displays the current time on top of the timeline
 */
export default class Timebar extends React.Component {
  constructor(props) {
    super(props);
    this.state = {};

    this.guessResolution = this.guessResolution.bind(this);
    this.renderBar = this.renderBar.bind(this);
    this.renderTopBar = this.renderTopBar.bind(this);
    this.renderBottomBar = this.renderBottomBar.bind(this);
  }

  componentWillMount() {
    this.guessResolution();
  }
  /**
   * On new props we check if a resolution is given, and if not we guess one
   * @param {Object} nextProps Props coming in
   */
  componentWillReceiveProps(nextProps) {
    if (nextProps.top_resolution &amp;&amp; nextProps.bottom_resolution) {
      this.setState({resolution: {top: nextProps.top_resolution, bottom: nextProps.bottom_resolution}});
    } else {
      this.guessResolution(nextProps.start, nextProps.end);
    }
  }

  /**
   * Attempts to guess the resolution of the top and bottom halves of the timebar based on the viewable date range.
   * Sets resolution to state.
   * @param {moment} start Start date for the timebar
   * @param {moment} end End date for the timebar
   */
  guessResolution(start, end) {
    if (!start || !end) {
      start = this.props.start;
      end = this.props.end;
    }
    const durationMilliSecs = end.diff(start);
    /// 1ms -&gt; 1s
    if (durationMilliSecs &lt;= 1000) this.setState({resolution: {top: &apos;second&apos;, bottom: &apos;millisecond&apos;}});
    // 1s  -&gt; 2m
    else if (durationMilliSecs &lt;= 60 * 2 * 1000) this.setState({resolution: {top: &apos;minute&apos;, bottom: &apos;second&apos;}});
    // 2m -&gt; 2h
    else if (durationMilliSecs &lt;= 60 * 60 * 2 * 1000) this.setState({resolution: {top: &apos;hour&apos;, bottom: &apos;minute&apos;}});
    // 2h -&gt; 3d
    else if (durationMilliSecs &lt;= 24 * 60 * 60 * 3 * 1000) this.setState({resolution: {top: &apos;day&apos;, bottom: &apos;hour&apos;}});
    // 1d -&gt; 30d
    else if (durationMilliSecs &lt;= 30 * 24 * 60 * 60 * 1000) this.setState({resolution: {top: &apos;month&apos;, bottom: &apos;day&apos;}});
    //30d -&gt; 1y
    else if (durationMilliSecs &lt;= 365 * 24 * 60 * 60 * 1000)
      this.setState({resolution: {top: &apos;year&apos;, bottom: &apos;month&apos;}});
    // 1y -&gt;
    else this.setState({resolution: {top: &apos;year&apos;, bottom: &apos;year&apos;}});
  }

  /**
   * Renderer for top bar.
   * @returns {Object} JSX for top menu bar - based of time format &amp; resolution
   */
  renderTopBar() {
    let res = this.state.resolution.top;
    return this.renderBar({format: this.props.timeFormats.majorLabels[res], type: res});
  }
  /**
   * Renderer for bottom bar.
   * @returns {Object} JSX for bottom menu bar - based of time format &amp; resolution
   */
  renderBottomBar() {
    let res = this.state.resolution.bottom;
    return this.renderBar({format: this.props.timeFormats.minorLabels[res], type: res});
  }
  /**
   * Gets the number of pixels per segment of the timebar section (using the resolution)
   * @param {moment} date The date being rendered. This is used to figure out how many days are in the month
   * @param {string} resolutionType Timebar section resolution [Year; Month...]
   * @returns {number} The number of pixels per segment
   */
  getPixelIncrement(date, resolutionType, offset = 0) {
    const {start, end} = this.props;
    const width = this.props.width - this.props.leftOffset;

    const start_end_ms = end.diff(start, &apos;milliseconds&apos;);
    const pixels_per_ms = width / start_end_ms;
    function isLeapYear(year) {
      return year % 400 === 0 || (year % 100 !== 0 &amp;&amp; year % 4 === 0);
    }
    const daysInYear = isLeapYear(date.year()) ? 366 : 365;
    let inc = width;
    switch (resolutionType) {
      case &apos;year&apos;:
        inc = pixels_per_ms * 1000 * 60 * 60 * 24 * (daysInYear - offset);
        break;
      case &apos;month&apos;:
        inc = pixels_per_ms * 1000 * 60 * 60 * 24 * (date.daysInMonth() - offset);
        break;
      case &apos;day&apos;:
        inc = pixels_per_ms * 1000 * 60 * 60 * (24 - offset);
        break;
      case &apos;hour&apos;:
        inc = pixels_per_ms * 1000 * 60 * (60 - offset);
        break;
      case &apos;minute&apos;:
        inc = pixels_per_ms * 1000 * 60 - offset;
        break;
      case &apos;second&apos;:
        inc = pixels_per_ms * 1000 - offset;
        break;
      case &apos;millisecond&apos;:
        inc = pixels_per_ms - offset;
        break;
      default:
        break;
    }
    return Math.min(inc, width);
  }
  /**
   * Renders an entire segment of the timebar (top or bottom)
   * @param {string} resolution The resolution to render at [Year; Month...]
   * @returns {Object[]} A list of sections (making up a segment) to be rendered
   * @property {string} label The text displayed in the section (usually the date/time)
   * @property {boolean} isSelected Whether the section is being &apos;touched&apos; when dragging/resizing
   * @property {number} size The number of pixels the segment will take up
   * @property {number|string} key Key for react
   */
  renderBar(resolution) {
    const {start, end, selectedRanges} = this.props;
    const width = this.props.width - this.props.leftOffset;

    let currentDate = start.clone();
    let timeIncrements = [];
    let pixelsLeft = width;
    let labelSizeLimit = 60;

    function _addTimeIncrement(initialOffset, offsetType, stepFunc) {
      let offset = null;
      while (currentDate.isBefore(end) &amp;&amp; pixelsLeft &gt; 0) {
        // if this is the first &apos;block&apos; it may be cut off at the start
        if (pixelsLeft === width) {
          offset = initialOffset;
        } else {
          offset = moment.duration(0);
        }
        let pixelIncrements = Math.min(
          this.getPixelIncrement(currentDate, resolution.type, offset.as(offsetType)),
          pixelsLeft
        );
        const labelSize = pixelIncrements &lt; labelSizeLimit ? &apos;short&apos; : &apos;long&apos;;
        let label = currentDate.format(resolution.format[labelSize]);
        let isSelected = _.some(selectedRanges, s =&gt; {
          return (
            currentDate.isSameOrAfter(s.start.clone().startOf(resolution.type)) &amp;&amp;
            currentDate.isSameOrBefore(s.end.clone().startOf(resolution.type))
          );
        });
        timeIncrements.push({label, isSelected, size: pixelIncrements, key: pixelsLeft});
        stepFunc(currentDate, offset);
        pixelsLeft -= pixelIncrements;
      }
    }

    const addTimeIncrement = _addTimeIncrement.bind(this);

    if (resolution.type === &apos;year&apos;) {
      const offset = moment.duration(currentDate.diff(currentDate.clone().startOf(&apos;year&apos;)));
      addTimeIncrement(offset, &apos;months&apos;, (currentDt, offst) =&gt; currentDt.subtract(offst).add(1, &apos;year&apos;));
    } else if (resolution.type === &apos;month&apos;) {
      const offset = moment.duration(currentDate.diff(currentDate.clone().startOf(&apos;month&apos;)));
      addTimeIncrement(offset, &apos;days&apos;, (currentDt, offst) =&gt; currentDt.subtract(offst).add(1, &apos;month&apos;));
    } else if (resolution.type === &apos;day&apos;) {
      const offset = moment.duration(currentDate.diff(currentDate.clone().startOf(&apos;day&apos;)));
      addTimeIncrement(offset, &apos;hours&apos;, (currentDt, offst) =&gt; currentDt.subtract(offst).add(1, &apos;days&apos;));
    } else if (resolution.type === &apos;hour&apos;) {
      const offset = moment.duration(currentDate.diff(currentDate.clone().startOf(&apos;hour&apos;)));
      addTimeIncrement(offset, &apos;minutes&apos;, (currentDt, offst) =&gt; currentDt.subtract(offst).add(1, &apos;hours&apos;));
    } else if (resolution.type === &apos;minute&apos;) {
      const offset = moment.duration(currentDate.diff(currentDate.clone().startOf(&apos;minute&apos;)));
      addTimeIncrement(offset, &apos;minutes&apos;, (currentDt, offst) =&gt; currentDt.subtract(offst).add(1, &apos;minutes&apos;));
    } else if (resolution.type === &apos;second&apos;) {
      const offset = moment.duration(currentDate.diff(currentDate.clone().startOf(&apos;second&apos;)));
      addTimeIncrement(offset, &apos;second&apos;, (currentDt, offst) =&gt; currentDt.subtract(offst).add(1, &apos;seconds&apos;));
    } else if (resolution.type === &apos;millisecond&apos;) {
      addTimeIncrement(moment.duration(0), &apos;millisecond&apos;, (currentDt, offst) =&gt; currentDt.add(1, &apos;milliseconds&apos;));
    }
    return timeIncrements;
  }

  /**
   * It renders the header of a column in multi columns mode. Default renderer: props.groupTitleRenderer;
   * which may be overriden per column: column.headerRender (react element or function).
   * @param {object} column
   */
  renderColumnHeader(column, index) {
    const columnWidth = column.width ? column.width : this.props.groupOffset;
    return (
      &lt;div className=&quot;rct9k-timebar-group-title&quot; key={index} style={{width: columnWidth}}&gt;
        {column.headerRenderer ? (
          React.isValidElement(column.headerRenderer) ? (
            column.headerRenderer
          ) : (
            &lt;column.headerRenderer /&gt;
          )
        ) : (
          &lt;this.props.groupTitleRenderer column={column} /&gt;
        )}
      &lt;/div&gt;
    );
  }

  /**
   * Renders the timebar
   * @returns {Object} Timebar component
   */
  render() {
    const {cursorTime, tableColumns} = this.props;
    const topBarComponent = this.renderTopBar();
    const bottomBarComponent = this.renderBottomBar();
    const GroupTitleRenderer = this.props.groupTitleRenderer;

    // Only show the cursor on 1 of the top bar segments
    // Pick the segment that has the biggest size
    let topBarCursorKey = null;
    if (topBarComponent.length &gt; 1 &amp;&amp; topBarComponent[1].size &gt; topBarComponent[0].size)
      topBarCursorKey = topBarComponent[1].key;
    else if (topBarComponent.length &gt; 0) topBarCursorKey = topBarComponent[0].key;

    return (
      &lt;div className=&quot;rct9k-timebar&quot; style={{width: this.props.width}}&gt;
        {/* Single column mode */}
        {(!tableColumns || tableColumns.length == 0) &amp;&amp; (
          &lt;div className=&quot;rct9k-timebar-group-title&quot; style={{width: this.props.leftOffset}}&gt;
            &lt;GroupTitleRenderer /&gt;
          &lt;/div&gt;
        )}
        {/* Multiple columns mode */}
        {tableColumns &amp;&amp;
          tableColumns.length &gt; 0 &amp;&amp;
          tableColumns.map((column, index) =&gt; {
            return this.renderColumnHeader(column, index);
          })}
        &lt;div className=&quot;rct9k-timebar-outer&quot; style={{width: this.props.width - this.props.leftOffset}}&gt;
          &lt;div className=&quot;rct9k-timebar-inner rct9k-timebar-inner-top&quot;&gt;
            {_.map(topBarComponent, i =&gt; {
              let topLabel = i.label;
              if (cursorTime &amp;&amp; i.key === topBarCursorKey) {
                topLabel += ` [${cursorTime}]`;
              }
              let className = &apos;rct9k-timebar-item&apos;;
              if (i.isSelected) className += &apos; rct9k-timebar-item-selected&apos;;
              return (
                &lt;span className={className} key={i.key} style={{width: intToPix(i.size)}}&gt;
                  {topLabel}
                &lt;/span&gt;
              );
            })}
          &lt;/div&gt;
          &lt;div className=&quot;rct9k-timebar-inner rct9k-timebar-inner-bottom&quot;&gt;
            {_.map(bottomBarComponent, i =&gt; {
              let className = &apos;rct9k-timebar-item&apos;;
              if (i.isSelected) className += &apos; rct9k-timebar-item-selected&apos;;
              return (
                &lt;span className={className} key={i.key} style={{width: intToPix(i.size)}}&gt;
                  {i.label}
                &lt;/span&gt;
              );
            })}
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    );
  }
}

Timebar.propTypes = {
  cursorTime: PropTypes.any,
  groupTitleRenderer: PropTypes.func,
  start: PropTypes.object.isRequired, //moment
  end: PropTypes.object.isRequired, //moment
  width: PropTypes.number.isRequired,
  leftOffset: PropTypes.number,
  top_resolution: PropTypes.string,
  bottom_resolution: PropTypes.string,
  selectedRanges: PropTypes.arrayOf(PropTypes.object), // [start: moment ,end: moment (end)]
  timeFormats: PropTypes.object,
  tableColumns: PropTypes.arrayOf(PropTypes.object)
};
Timebar.defaultProps = {
  selectedRanges: [],
  groupTitleRenderer: DefaultColumnHeaderRenderer,
  leftOffset: 0,
  timeFormats: defaultTimebarFormat,
  tableColumns: []
};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
